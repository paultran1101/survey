<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khảo sát ý kiến người dùng</title>
    <style>
        body {
            font-family: "Times New Roman", Times, serif !important;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        #form-container {
            margin: 20px 0;
        }
        #message {
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            display: none;
        }
        .success { background-color: #d4edda; color: #155724; }
        .warning { background-color: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <h1>Khảo sát ý kiến người dùng</h1>
    <p>Cảm ơn bạn đã tham gia khảo sát! Mỗi thiết bị chỉ được tham gia một lần.</p>
    
    <div id="message" class="warning">
        Bạn đã tham gia khảo sát này trước đây. Mỗi thiết bị chỉ được gửi một lần.
    </div>
    
    <div id="form-container">
        <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSeCUHBgqg7HXLoNJB05tm6U5vwZGp4cBVWgI1rZVfXHAcWO0A/viewform?embedded=true" 
                width="100%" 
                height="800" 
                frameborder="0" 
                marginheight="0" 
                marginwidth="0">
            Đang tải...
        </iframe>
    </div>

    <script>
        // Kiểm tra local storage khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            const formSubmitted = localStorage.getItem('surveySubmitted');
            const messageDiv = document.getElementById('message');
            const formContainer = document.getElementById('form-container');
            
            if (formSubmitted) {
                // Đã submit trước đó
                messageDiv.style.display = 'block';
                formContainer.style.display = 'none';
            } else {
                // Theo dõi sự kiện submit form
                startFormMonitoring();
            }
        });

        function startFormMonitoring() {
            // Kiểm tra mỗi 2 giây xem form đã được submit chưa
            const checkInterval = setInterval(function() {
                const iframe = document.querySelector('iframe');
                if (iframe) {
                    try {
                        // Kiểm tra URL của iframe - khi submit thành công sẽ chuyển hướng
                        const currentUrl = iframe.src || iframe.contentWindow.location.href;
                        
                        if (currentUrl.includes('/formResponse') || 
                            currentUrl.includes('thankyou') || 
                            currentUrl.includes('response')) {
                            
                            // Đánh dấu đã submit
                            localStorage.setItem('surveySubmitted', 'true');
                            localStorage.setItem('submitTime', new Date().toISOString());
                            
                            clearInterval(checkInterval);
                            
                            // Hiển thị thông báo
                            showThankYouMessage();
                        }
                    } catch (e) {
                        // Bỏ qua lỗi cross-origin
                        console.log('Không thể truy cập iframe content');
                    }
                }
            }, 2000);
        }

        function showThankYouMessage() {
            const messageDiv = document.getElementById('message');
            const formContainer = document.getElementById('form-container');
            
            messageDiv.textContent = 'Cảm ơn bạn đã tham gia khảo sát! Câu trả lời của bạn đã được ghi nhận.';
            messageDiv.className = 'success';
            messageDiv.style.display = 'block';
            formContainer.style.display = 'none';
        }

        // Thêm event listener cho beforeunload (khi người dùng rời trang)
        window.addEventListener('beforeunload', function() {
            const iframe = document.querySelector('iframe');
            if (iframe) {
                try {
                    const iframeUrl = iframe.src || iframe.contentWindow.location.href;
                    if (iframeUrl.includes('/formResponse')) {
                        localStorage.setItem('surveySubmitted', 'true');
                    }
                } catch (e) {
                    // Bỏ qua lỗi cross-origin
                }
            }
        });
    </script>
</body>
</html>